{# templates/Document/_track_card.html.twig #}
{# Verwacht:
   - trackForm : het (sub)form (kan prototype of echte zijn)
   - index     : index voor IDs (bijv. 0, 1, 2 of "__name__")
   - num       : menselijk nummer (1, 2, 3 of "__num__")
   - isPrototype : bool
#}

<div class="track-card">
    <div class="track-head">
        <div class="track-title">Track {{ num }}</div>
        <div class="track-actions">
            <button type="button" class="btn-mini danger" onclick="removeTrack(this)">Verwijder</button>
        </div>
    </div>

    {# Hidden trackId #}
    {{ form_widget(trackForm.trackId) }}

    <div class="grid">
        <div class="subsection">

            {# Label + tegels op één regel #}
            <div class="label-with-tiles">
                <label class="label">Levels</label>
                {# A) Tegelcontainer (visueel) #}
                <div id="trk-tiles-{{ index }}"
                     class="ld-tiles"
                     data-target="#trk-hidden-{{ index }}"></div>
            </div>

            {# B) Verborgen inputs die Symfony leest #}
            <div id="trk-hidden-{{ index }}"
                 class="ld-hidden"
                 data-prototype="{{ form_widget(trackForm.levels.vars.prototype)|e('html_attr') }}"
                 data-index="{{ (trackForm.levels|length)|default(0) }}">

                {# Bij echt form: bestaande level-inputs renderen.
                   Bij prototype: leeg laten, JS seedt ze. #}
                {% if not isPrototype %}
                    {% for levelField in trackForm.levels %}
                        <div class="ld-item">{{ form_widget(levelField) }}</div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        {# -- AreaOfInterest -- #}
        <div class="subsection">
            {# Label + grid-tiles op één regel #}
            <div class="label-with-tiles">
                <label class="label">Area of interest</label>

                {# grid container (JS zet columns) #}
                <div id="aoi-tiles-{{ index }}"
                     class="aoi-tiles"
                     data-target="#aoi-hidden-{{ index }}"></div>
            </div>

            {# verborgen inputs die Symfony leest #}
            <div id="aoi-hidden-{{ index }}"
                 class="ld-hidden"
                 data-prototype="{{ form_widget(trackForm.areaOfInterest.vars.prototype)|e('html_attr') }}"
                 data-index="{{ (trackForm.areaOfInterest|length)|default(0) }}">

                {% if not isPrototype %}
                    {% for field in trackForm.areaOfInterest %}
                        <div class="ld-item">{{ form_widget(field) }}</div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>


        <div class="subsection">
            <label class="label">MIDI bestand</label>
            {{ form_widget(trackForm.midiAsset) }}

            {% set info = midiInfo[trackForm.trackId.vars.value] ?? null %}
            {% set totalBars = info.bars ?? 0 %}
            {% set timeSig   = info.timeSig ?? '4/4' %}

            {% if info %}
                {% if info.error is defined %}
                    <p class="danger" style="margin-top:6px">
                        Kan MIDI analyseren: {{ info.error }}
                    </p>
                {% else %}
                    <div class="midi-info">
                        <div><strong>Duur:</strong> {{ info.duration }}</div>
                        <div><strong>BPM:</strong> {{ info.bpm }}</div>
                        {% if info.timeSig %}
                            <div><strong>Maatsoort:</strong> {{ info.timeSig }}</div>
                        {% endif %}
                        {% if info.bars %}
                            <div><strong>Maten:</strong> {{ info.bars }}</div>
                        {% endif %}
                    </div>
                {% endif %}

                <div
                        class="loop-editor js-loop-editor"
                        data-total-bars="{{ totalBars }}"
                        data-timesig="{{ timeSig }}"
                        data-input-id="{{ trackForm.loopLength.vars.id }}"
                >
                    {# 0) Verborgen input die Symfony leest en waar JS in schrijft #}
                    <div class="loop-hidden-input">
                        {{ form_widget(trackForm.loopLength) }}
                    </div>

                    {# 1) Override veld + stepper #}
                    <div class="loop-base-wrapper">
                        <div class="loop-base-header">
                            <span class="label-small">Basismaten</span>
                        </div>
                        <div class="loop-base-controls">
                            {{ form_widget(trackForm.loopLengthOverride, {
                                attr: trackForm.loopLengthOverride.vars.attr|merge({
                                    class: (trackForm.loopLengthOverride.vars.attr.class|default('') ~ ' js-loop-base-input')|trim
                                })
                            }) }}
                            <button type="button" class="btn btn-mini js-loop-base-dec">–</button>
                            <button type="button" class="btn btn-mini js-loop-base-inc">+</button>
                        </div>
                    </div>

                    {# 2) De daadwerkelijke loop-segmenten chips #}
                    <div class="loop-chips js-loop-chips">
                        {# wordt door JS gevuld #}
                    </div>

                    {# 3) Segment-knoppen #}
                    <div class="loop-actions">
                        <button type="button" class="btn btn-mini js-loop-reset">
                            Basis
                        </button>
                        <button type="button" class="btn btn-mini js-loop-add">
                            + Loop
                        </button>
                        <button type="button" class="btn btn-mini js-loop-remove">
                            – Loop
                        </button>
                    </div>
                </div>

            {% endif %}


            {% if not isPrototype
                and trackForm.midiAsset.vars.choices is defined
                and trackForm.midiAsset.vars.choices|length == 0 %}
                <p class="subtle" style="margin-top:6px">
                    Nog geen MIDI-assets. Upload ze bovenaan.
                </p>
            {% endif %}
        </div>

        <div class="subsection">
            <label class="label">EXS preset</label>
            {{ form_widget(trackForm.exsPreset) }}
        </div>

    </div>
</div>
