{# templates/document/edit.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ document.title }}{% endblock %}

{% block body %}
    <div class="wrap">
        <div class="card">
            <h1 class="title">Bewerken Set: {{ document.title }}</h1>
            <p class="subtitle">Publiceer Symphonic eMotions muziek sets.</p>

            {% form_theme form 'forms/_theme.html.twig' %}
            {{ form_start(form, { attr: { id: 'document-form', enctype: 'multipart/form-data' } }) }}

            {# --- Set gegevens (Titel / Grid / BPM) --- #}
            <div class="section">
                <div class="grid grid-2">
                    <div class="grid">
                        {{ form_row(form.title) }}
                    </div>
                    <div class="grid">
                        {{ form_row(form.gridSize) }}
                        {{ form_row(form.setBPM) }}
                    </div>
                </div>
            </div>

            {# --- Assets --- #}
            <div class="section">
                <h2 class="section-title">Bestanden</h2>
                <div class="grid grid-2">
                    <div>
                        {{ form_row(form.midiFiles) }}
                    </div>

                    <div>
                        <label class="label">MIDI bestanden op server</label>
                        {% if assets is defined and assets|length %}
                            <div class="chips" style="margin-top:8px">
                                {% for a in assets %}
                                    <div class="chip">
                                        <div class="chip-main">
                                            <span class="chip-name">{{ a.originalName }}</span>
                                            <span class="chip-meta subtle">
                                              ({% if a.size is not null %}{{ (a.size / 1024)|number_format(1, '.', ' ') }} KB{% else %}–{% endif %})
                                            </span>
                                        </div>

                                        <div class="chip-actions">
                                            <a href="{{ path('doc_asset_download', { id: document.id, assetId: a.id }) }}" class="btn-mini">Download</a>
                                            <button
                                                    type="button"
                                                    class="btn-mini danger"
                                                    data-url="{{ path('doc_asset_delete', { id: document.id, assetId: a.id }) }}"
                                                    data-csrf="{{ csrf_token('delete-asset-' ~ a.id) }}"
                                                    data-name="{{ a.originalName }}"
                                                    onclick="deleteAsset(this.dataset.url, this.dataset.csrf, this.dataset.name)"
                                            >
                                                Verwijder
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="subtle" style="margin-top:6px">
                                Nog geen bestanden naar de server verzonden. Upload één of meer .mid-bestanden.
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# --- LevelDurations custom UI (tegels) --- #}
            <div class="section">
                    <h2 class="section-title">Aantal levels voor deze set</h2>

                <div class="ld-row align-items-center">
                    {# 1. Tegels #}
                    <div id="ld-tiles" class="ld-tiles" data-target="#ld-hidden-inputs"></div>

                    {# 2. Acties rechts naast de tegels #}
                    <div class="ld-actions">
                        <button type="button" class="btn-mini" id="ld-add">+ Toevoegen</button>
                        <button type="button" class="btn-mini secondary" id="ld-remove">
                            – Verwijder laatste
                        </button>
                    </div>

                    {# 3. Track toevoegen rechts uitgelijnd op dezelfde rij #}
                    <div class="ld-track-add">
                        <button type="button" class="btn" id="add-track">+ Track toevoegen</button>
                    </div>
                </div>

                {# Hidden inputs #}
                <div id="ld-hidden-inputs"
                     class="ld-hidden"
                     data-prototype="{{ form_widget(form.levelDurations.vars.prototype)|e('html_attr') }}"
                     data-index="{{ form.levelDurations|length }}">
                    {% for field in form.levelDurations %}
                        <div class="ld-item">
                            {{ form_widget(field) }}
                        </div>
                    {% endfor %}
                </div>

                {% do form.levelDurations.setRendered %}
            </div>

            {# --- Tracks (DocumentTrack) --- #}
            <div class="section">

                {# 1) Prototype track-kaart #}
                {% set track_proto %}
                    {% include 'Document/_track_card.html.twig' with {
                        trackForm:   form.tracks.vars.prototype,
                        index:       '__name__',
                        num:         '__num__',
                        isPrototype: true,
                        midiInfo:    {}
                    } only %}
                {% endset %}

                {# 2) Container met bestaande tracks #}
                <div id="tracks"
                     class="tracks"
                     data-index="{{ form.tracks|length }}"
                     data-prototype="{{ track_proto|e('html_attr') }}">

                    {% for trackForm in form.tracks %}
                        {% include 'Document/_track_card.html.twig' with {
                            trackForm:   trackForm,
                            index:       loop.index0,
                            num:         loop.index,
                            isPrototype: false,
                            midiInfo:    midiInfo
                        } only %}
                    {% else %}
                        <p class="subtle">Nog geen tracks. Voeg er één toe.</p>
                    {% endfor %}
                </div>
            </div>

            {# Markeer custom gerenderde velden #}
            {% do form.tracks.setRendered %}

            {# Render published alvast, maar bewaar in variabele. Hierdoor is hij "gerenderd" vóór form_rest. #}
            {% set publishedRow %}
                {{ form_row(form.published, {
                    attr: form.published.vars.attr|merge({ form: 'document-form' })
                }) }}
            {% endset %}

            {{ form_rest(form) }}
            {{ form_end(form, { render_rest: false }) }}

        </div>
    </div>

    {# --- Sticky/Fixed bottom bar OUTSIDE card/wrap --- #}
    <div class="bottom-bar">
        <div class="bottom-bar-inner">

            <div class="bottom-bar-flashes">
                {% for type, messages in app.flashes %}
                    {% for msg in messages %}
                        <div class="flash flash-{{ type }}">{{ msg }}</div>
                    {% endfor %}
                {% endfor %}
            </div>

            <div class="bottom-bar-actions">
                <div class="bottom-bar-published">
                    {{ publishedRow|raw }}
                    <a
                            href="{{ path('doc_api_json', { id: document.id }) }}"
                            title="Download laatst opgeslagen JSON voor deze set"
                            style="
                                padding-left: 4px;
                                text-decoration:none;
                                font-size: 13px;
                                color: var(--muted);
                                "
                    >⬇️<span style="padding-left: 10px;">Download</span></a>
                </div>

                <button class="btn" type="submit" form="document-form">Opslaan</button>
                <a class="btn secondary" href="{{ path('app_dashboard') }}">Terug</a>
            </div>

        </div>
    </div>
    <script src="{{ asset('js/semLoopConfig.js') }}"></script>
    <script src="{{ asset('js/leveldurationsTracksAOI.js') }}" defer></script>
    <script src="{{ asset('js/loopLengthEditor.js') }}" defer></script>
    <script src="{{ asset('js/effectsSettings.js') }}" defer></script>
    <script>
        window.EFFECT_PRESET_MAP = {{ allEffectPresetsMap|json_encode|raw }};
    </script>

{% endblock %}
