{# templates/document/edit.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ document.title }}{% endblock %}

{% block body %}
    <div class="wrap">
        <div class="card">
            <h1 class="title">Bewerken Set: {{ document.title }}</h1>
            <p class="subtitle">
                Symphonic eMotion Set bestanden kun je voorzien van MIDI-bestanden die je in een track kunt selecteren.
            </p>

            {# 1 formulier voor alles (zonder geneste forms) #}
            {% form_theme form 'forms/_theme.html.twig' %}
            {{ form_start(form, { attr: { enctype: 'multipart/form-data' } }) }}

            {# --- Set gegevens --- #}
            <div class="section">
                {{ form_row(form.title) }}
{#                {{ form_row(form.semVersion) }}#}
                {{ form_row(form.gridSize) }}
                {{ form_row(form.setBPM) }}
                {# {{ form_row(form.levelDurations) }} #}
            </div>

            {# --- Upload veld (onderdeel van hoofdformulier) --- #}
            <div class="section">
                <h2 class="section-title">Assets uploaden</h2>
                {{ form_row(form.midiFiles) }}
            </div>

            {# --- Tracks container (NU: DocumentTrack) --- #}
            <div class="section">
                <div class="form-actions" style="margin-top:10px">
                    <button type="button" class="btn" id="add-track">+ Track toevoegen</button>
                </div>

                {# We tonen bestaande tracks met expliciete rendering #}
                <div id="tracks" class="tracks" data-index="{{ form.tracks|length }}">
                    {% for trackForm in form.tracks %}
                        <div class="track-card">
                            <div class="track-head">
                                <div class="track-title">Track {{ loop.index }}</div>
                                <div class="track-actions">
                                    <button type="button" class="btn-ghost" onclick="duplicateTrack(this)">Dupliceren</button>
                                    <button type="button" class="btn-ghost danger" onclick="removeTrack(this)">Verwijderen</button>
                                </div>
                            </div>

                            {# trackId (hidden) #}
                            {{ form_widget(trackForm.trackId) }}

                            <div class="grid">
                                {# Levels: Collection<IntegerType> #}
                                <div class="subsection">
                                    <label class="label">Levels</label>
                                    <div
                                            id="levels-{{ loop.index0 }}"
                                            class="collection"
                                            data-prototype="{{ form_widget(trackForm.levels.vars.prototype)|e('html_attr') }}"
                                            data-index="{{ trackForm.levels|length }}"
                                    >
                                        {% for levelField in trackForm.levels %}
                                            <div class="collection-item">
                                                {{ form_widget(levelField) }}
                                                <button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn-mini" onclick="addCollectionItem('levels-{{ loop.index0 }}')">+ Level</button>
                                </div>

                                {# MIDI asset: enkele EntityType-select #}
                                <div class="subsection">
                                    <label class="label">MIDI bestand</label>
                                    {{ form_widget(trackForm.midiAsset) }}
                                    {% if trackForm.midiAsset.vars.choices is defined and trackForm.midiAsset.vars.choices|length == 0 %}
                                        <p class="subtle" style="margin-top:6px">
                                            Er zijn nog geen MIDI-assets voor deze set. Upload ze bovenaan bij “Assets uploaden”.
                                        </p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="subtle">Nog geen tracks. Voeg er één toe.</p>
                    {% endfor %}
                </div>
            </div>

            {{ form_row(form.published) }}

            {# --- Acties onderaan --- #}
            <div class="form-actions">
                <button class="btn" type="submit">Opslaan</button>
                <a class="btn secondary" href="{{ path('app_dashboard') }}">Terug</a>
            </div>

            {# markeer het parent-veld als gerenderd, omdat we de children custom renderen #}
            {% do form.tracks.setRendered %}



            {{ form_end(form) }}

            {# =========================
               Assets-lijst BUITEN het hoofdformulier
               ========================= #}
            <div class="section">
                <h2 class="section-title">Bestanden (Assets) {{ document.title }}</h2>
                {% if assets is defined and assets|length %}
                    <div class="chips" style="margin-top:8px">
                        {% for a in assets %}
                            <div class="chip">
                                <span>{{ a.originalName }}</span>
                                <span class="subtle">
                                  ({% if a.size is not null %}{{ (a.size / 1024)|number_format(1, '.', ' ') }} KB{% else %}–{% endif %})
                                </span>
                                <div class="chip-actions">
                                    <a href="{{ path('doc_asset_download', { id: document.id, assetId: a.id }) }}" class="btn-mini">Download</a>
                                    <form action="{{ path('doc_asset_delete', { id: document.id, assetId: a.id }) }}"
                                          method="post"
                                          onsubmit="return confirm('Weet je zeker dat je {{ a.originalName }} wilt verwijderen?');"
                                          style="display:inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete-asset-' ~ a.id) }}">
                                        <button type="submit" class="btn-mini danger">Verwijder</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="subtle" style="margin-top:6px">Nog geen assets. Upload één of meer .mid-bestanden.</p>
                {% endif %}
            </div>
        </div>
    </div>

    {# ===== Prototype voor nieuwe tracks (volledige HTML van het track-form) ===== #}
    <template id="track-proto">
        {{ form_widget(form.tracks.vars.prototype)|e('html') }}
    </template>

    {# ===== JS helpers ===== #}
    <script>
        (function() {
            // Generic: add/remove item in a collection that has a data-prototype
            window.addCollectionItem = function(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const index = parseInt(container.dataset.index || '0', 10);
                const proto = container.dataset.prototype.replace(/__name__/g, index);
                const wrapper = document.createElement('div');
                wrapper.className = 'collection-item';
                wrapper.innerHTML = proto + '<button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>';
                container.appendChild(wrapper);
                container.dataset.index = index + 1;
            };

            window.removeCollectionItem = function(btn) {
                const item = btn.closest('.collection-item');
                if (item) item.remove();
            };

            function seedCollectionIfEmpty(container) {
                if (!container) return;
                const currentIndex = parseInt(container.dataset.index || '0', 10);
                const hasAny = container.querySelector('.collection-item, input, select, textarea');
                if (!hasAny || currentIndex === 0) {
                    window.addCollectionItem(container.id);
                }
            }

            // Bouw een kaart vanuit het track-prototype
            function buildTrackCardFromPrototype(trackIndex) {
                const t = document.getElementById('track-proto');
                if (!t) return null;
                const protoHTML = t.innerHTML;

                // We parsen het prototype om de relevante velden eruit te halen (trackId, levels-collection, midiAsset-select)
                const temp = document.createElement('div');
                temp.innerHTML = protoHTML;

                const trackIdInput = temp.querySelector('input[type="hidden"][name*="[trackId]"]') || document.createElement('input');
                const levelsDiv = temp.querySelector('[data-prototype]'); // levels-collection
                const midiSelect = temp.querySelector('select[name*="[midiAsset]"]') || temp.querySelector('input[name*="[midiAsset]"]');

                // Normaliseer ids/dataset
                if (levelsDiv) {
                    levelsDiv.id = 'levels-dyn-' + trackIndex;
                    if (levelsDiv.dataset.index === undefined) levelsDiv.dataset.index = '0';
                }

                const card = document.createElement('div');
                card.className = 'track-card';
                card.innerHTML = `
                    <div class="track-head">
                        <div class="track-title">Track ${trackIndex + 1}</div>
                        <div class="track-actions">
<!--                            <button type="button" class="btn-ghost" onclick="duplicateTrack(this)">Dupliceren</button>-->
                            <button type="button" class="btn-ghost danger" onclick="removeTrack(this)">Verwijderen</button>
                        </div>
                    </div>
                    <div class="grid">
                        <input type="hidden">
                        <div class="subsection">
                            <label class="label">Levels</label>
                            <div class="collection"></div>
                            <button type="button" class="btn-mini">+ Level</button>
                        </div>
                        <div class="subsection">
                            <label class="label">MIDI bestand</label>
                            <div class="midi-slot"></div>
                        </div>
                    </div>
                `;

                // Hidden trackId invullen
                card.querySelector('input[type="hidden"]').replaceWith(trackIdInput);

                // Levels collection in de juiste plek
                const levelsSlot = card.querySelectorAll('.subsection .collection')[0];
                if (levelsDiv) levelsSlot.replaceWith(levelsDiv);

                // MIDI select in de juiste plek
                const midiSlot = card.querySelector('.midi-slot');
                if (midiSelect) midiSlot.replaceWith(midiSelect);

                // Wire de +Level knop
                const levelBtn = card.querySelectorAll('.subsection .btn-mini')[0];
                if (levelBtn && levelsDiv) levelBtn.addEventListener('click', () => addCollectionItem(levelsDiv.id));

                // 1 initiële level-rij
                seedCollectionIfEmpty(levelsDiv);

                return card;
            }

            // Tracks container
            const container = document.getElementById('tracks');
            if (!container) return;

            // Add Track button
            const addBtn = document.getElementById('add-track');
            addBtn && addBtn.addEventListener('click', () => addTrack());

            window.addTrack = function() {
                const index = parseInt(container.dataset.index || '0', 10);
                const card = buildTrackCardFromPrototype(index);
                if (card) {
                    container.appendChild(card);
                    container.dataset.index = index + 1;
                }
            };

            window.removeTrack = function(btn) {
                const card = btn.closest('.track-card');
                if (card) card.remove();
            };

            // window.duplicateTrack = function(btn) {
            //     const card = btn.closest('.track-card');
            //     if (!card) return;
            //     addTrack();
            //     // (optioneel) waarden kopiëren van card → laatste card.
            // };

            // Seed: bestaande tracks op initial load (alleen levels seeden)
            document.querySelectorAll('#tracks .track-card').forEach((card) => {
                const levels = card.querySelector('[id^="levels-"]');
                seedCollectionIfEmpty(levels);
            });
        })();
    </script>

    <style>
        .tracks { display: grid; gap: 16px; }
        .track-card { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; background: rgba(255,255,255,0.03); }
        .track-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .track-title { font-weight:600; }
        .grid { display:grid; gap:12px; }
        .subsection .label { display:block; font-size:0.95rem; margin-bottom:6px; opacity:0.9; }
        .collection-item { display:flex; gap:8px; align-items:flex-start; margin-bottom:8px; }
        .btn-mini { font-size:0.85rem; padding:4px 8px; border-radius:8px; }
        .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.15); padding:6px 10px; border-radius:8px; }
        .btn-ghost.danger { border-color: rgba(255,0,0,0.35); color:#ff8585; }
        .chip { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid rgba(255,255,255,0.12); border-radius:999px; margin:4px 6px 4px 0; }
        .chip-actions { display:inline-flex; gap:6px; margin-left:6px; }
        .subtle { opacity:0.8; }
    </style>
{% endblock %}
