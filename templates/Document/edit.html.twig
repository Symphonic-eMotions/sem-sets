{# templates/document/edit.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ document.title }}{% endblock %}

{% block body %}
    <div class="wrap">
        <div class="card">
            <h1 class="title">Bewerken Set: {{ document.title }}</h1>
            <p class="subtitle">Koppel MIDI-bestanden aan tracks.</p>

            {% form_theme form 'forms/_theme.html.twig' %}
            {{ form_start(form, { attr: { enctype: 'multipart/form-data' } }) }}

            {# --- Set gegevens --- #}
            <div class="section">
                {{ form_row(form.title) }}
{#                {{ form_row(form.semVersion) }}#}

                {{ form_row(form.gridSize) }}
                {{ form_row(form.setBPM) }}
            </div>

            {# --- Upload veld --- #}
            <div class="section">
                <h2 class="section-title">Assets uploaden</h2>
                {{ form_row(form.midiFiles) }}
            </div>

            {# --- Tracks (DocumentTrack) --- #}
            <div class="section">
                <div class="form-actions" style="margin-top:10px">
                    <button type="button" class="btn" id="add-track">+ Track toevoegen</button>
                </div>

                {# Container met data-prototype = VOLLEDIGE track-kaart #}
                {# 1) Bouw EERST het volledige prototype als HTML #}
                {% set track_proto %}
                    <div class='track-card'>
                        <div class='track-head'>
                            <div class='track-title'>Track __num__</div>
                            <div class='track-actions'>
                                <button type='button' class='btn-ghost' onclick='duplicateTrack(this)'>Dupliceren</button>
                                <button type='button' class='btn-ghost danger' onclick='removeTrack(this)'>Verwijderen</button>
                            </div>
                        </div>

                        {{ form_widget(form.tracks.vars.prototype.trackId) }}

                        <div class='grid'>
                            <div class='subsection'>
                                <label class='label'>Levels</label>
                                <div class='collection'
                                     data-prototype='{{ form_widget(form.tracks.vars.prototype.levels.vars.prototype)|e('html_attr') }}'
                                     data-index='0'>
                                </div>
                                <button type='button' class='btn-mini add-level'>+ Level</button>
                            </div>

                            <div class='subsection'>
                                <label class='label'>MIDI bestand</label>
                                {{ form_widget(form.tracks.vars.prototype.midiAsset) }}
                            </div>
                        </div>
                    </div>
                {% endset %}

                {# 2) Stop de ge-escape-te HTML in het data-prototype attribuut #}
                <div id="tracks"
                     class="tracks"
                     data-index="{{ form.tracks|length }}"
                     data-prototype="{{ track_proto|e('html_attr') }}">

                    {# Bestaande tracks renderen #}
                    {% for trackForm in form.tracks %}
                        <div class="track-card">
                            <div class="track-head">
                                <div class="track-title">Track {{ loop.index }}</div>
                                <div class="track-actions">
                                    <button type="button" class="btn-ghost" onclick="duplicateTrack(this)">Dupliceren</button>
                                    <button type="button" class="btn-ghost danger" onclick="removeTrack(this)">Verwijderen</button>
                                </div>
                            </div>

                            {{ form_widget(trackForm.trackId) }}

                            <div class="grid">
                                <div class="subsection">
                                    <label class="label">Levels</label>
                                    <div id="levels-{{ loop.index0 }}"
                                         class="collection"
                                         data-prototype="{{ form_widget(trackForm.levels.vars.prototype)|e('html_attr') }}"
                                         data-index="{{ trackForm.levels|length }}">
                                        {% for levelField in trackForm.levels %}
                                            <div class="collection-item">
                                                {{ form_widget(levelField) }}
                                                <button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn-mini" onclick="addCollectionItem('levels-{{ loop.index0 }}')">+ Level</button>
                                </div>

                                <div class="subsection">
                                    <label class="label">MIDI bestand</label>
                                    {{ form_widget(trackForm.midiAsset) }}
                                    {% if trackForm.midiAsset.vars.choices is defined and trackForm.midiAsset.vars.choices|length == 0 %}
                                        <p class="subtle" style="margin-top:6px">Nog geen MIDI-assets. Upload ze bovenaan.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="subtle">Nog geen tracks. Voeg er één toe.</p>
                    {% endfor %}
                </div>

            </div>

            {{ form_row(form.published) }}

            {# --- Acties onderaan --- #}
            <div class="form-actions">
                <button class="btn" type="submit">Opslaan</button>
                <a class="btn secondary" href="{{ path('app_dashboard') }}">Terug</a>
            </div>

            {# markeer parent-veld als gerenderd, we doen custom rendering #}
            {% do form.tracks.setRendered %}

            {{ form_end(form) }}

            {# --- Assets-lijst (optioneel) --- #}
            <div class="section">
                <h2 class="section-title">Bestanden (Assets) {{ document.title }}</h2>
                {% if assets is defined and assets|length %}
                    <div class="chips" style="margin-top:8px">
                        {% for a in assets %}
                            <div class="chip">
                                <span>{{ a.originalName }}</span>
                                <span class="subtle">({% if a.size is not null %}{{ (a.size / 1024)|number_format(1, '.', ' ') }} KB{% else %}–{% endif %})</span>
                                <div class="chip-actions">
                                    <a href="{{ path('doc_asset_download', { id: document.id, assetId: a.id }) }}" class="btn-mini">Download</a>
                                    <form action="{{ path('doc_asset_delete', { id: document.id, assetId: a.id }) }}"
                                          method="post"
                                          onsubmit="return confirm('Weet je zeker dat je {{ a.originalName }} wilt verwijderen?');"
                                          style="display:inline">
                                        <input type="hidden" name="_token" value="{{ csrf_token('delete-asset-' ~ a.id) }}">
                                        <button type="submit" class="btn-mini danger">Verwijder</button>
                                    </form>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="subtle" style="margin-top:6px">Nog geen assets. Upload één of meer .mid-bestanden.</p>
                {% endif %}
            </div>

        </div>
    </div>

    {# ===== JS helpers ===== #}
    <script>
        (function() {
            // Voeg item toe aan een levels-collection (met eigen data-prototype)
            window.addCollectionItem = function(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const index = parseInt(container.dataset.index || '0', 10);
                const proto = container.dataset.prototype.replace(/__name__/g, index);
                const wrapper = document.createElement('div');
                wrapper.className = 'collection-item';
                wrapper.innerHTML = proto + '<button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>';
                container.appendChild(wrapper);
                container.dataset.index = index + 1;
            };
            window.removeCollectionItem = function(btn) {
                const item = btn.closest('.collection-item');
                if (item) item.remove();
            };

            const tracks = document.getElementById('tracks');
            if (!tracks) return;

            function addTrackFromPrototype() {
                const index = parseInt(tracks.dataset.index || '0', 10);
                // volledige kaart als prototype, met __name__ en een weergave teller __num__
                let html = tracks.dataset.prototype
                    .replace(/__name__/g, index)
                    .replace(/__num__/g, index + 1);

                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;
                const card = wrapper.firstElementChild;

                // Hook de +Level knop in de nieuwe kaart
                const collectionDiv = card.querySelector('.collection[data-prototype]');
                const addLevelBtn   = card.querySelector('.add-level');
                if (collectionDiv && addLevelBtn) {
                    // seed 1 level
                    if ((parseInt(collectionDiv.dataset.index||'0',10)) === 0) {
                        const seedProto = collectionDiv.dataset.prototype.replace(/__name__/g, 0);
                        const item = document.createElement('div');
                        item.className = 'collection-item';
                        item.innerHTML = seedProto + '<button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>';
                        collectionDiv.appendChild(item);
                        collectionDiv.dataset.index = '1';
                    }
                    addLevelBtn.addEventListener('click', () => {
                        const cid = 'levels-auto-' + index;
                        collectionDiv.id = cid;
                        addCollectionItem(cid);
                    });
                }

                tracks.appendChild(card);
                tracks.dataset.index = index + 1;
            }

            document.getElementById('add-track')?.addEventListener('click', addTrackFromPrototype);

            window.removeTrack = function(btn) {
                btn.closest('.track-card')?.remove();
            };
            window.duplicateTrack = function(btn) {
                addTrackFromPrototype();
                // (optioneel) copy values van huidige kaart naar laatste kaart
            };

            // Seed voor bestaande kaarten: zorg dat levels-collection minstens 1 rij heeft
            document.querySelectorAll('#tracks .track-card').forEach((card, i) => {
                const coll = card.querySelector('.collection[data-prototype]');
                if (coll && parseInt(coll.dataset.index || '0', 10) === 0) {
                    const seedProto = coll.dataset.prototype.replace(/__name__/g, 0);
                    const item = document.createElement('div');
                    item.className = 'collection-item';
                    item.innerHTML = seedProto + '<button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>';
                    coll.appendChild(item);
                    coll.dataset.index = '1';
                }
            });
        })();
    </script>

    <style>
        .tracks { display: grid; gap: 16px; }
        .track-card { border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px; background: rgba(255,255,255,0.03); }
        .track-head { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .track-title { font-weight:600; }
        .grid { display:grid; gap:12px; }
        .subsection .label { display:block; font-size:0.95rem; margin-bottom:6px; opacity:0.9; }
        .collection-item { display:flex; gap:8px; align-items:flex-start; margin-bottom:8px; }
        .btn-mini { font-size:0.85rem; padding:4px 8px; border-radius:8px; }
        .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.15); padding:6px 10px; border-radius:8px; }
        .btn-ghost.danger { border-color: rgba(255,0,0,0.35); color:#ff8585; }
        .chip { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid rgba(255,255,255,0.12); border-radius:999px; margin:4px 6px 4px 0; }
        .chip-actions { display:inline-flex; gap:6px; margin-left:6px; }
        .subtle { opacity:0.8; }
    </style>
{% endblock %}
