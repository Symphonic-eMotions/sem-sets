{# templates/document/edit.html.twig #}
{% extends 'base.html.twig' %}
{% block title %}{{ document.title }}{% endblock %}

{% block body %}
    {# Eventueel globale UI styles #}
    {# {% include '_partials/ui_styles.html.twig' %} #}

    <div class="wrap">
        <div class="card">
            <h1 class="title">Bewerken Set: {{ document.title }}</h1>
            <p class="subtitle">Koppel MIDI-bestanden aan tracks.</p>

            {% form_theme form 'forms/_theme.html.twig' %}
            {{ form_start(form, { attr: { enctype: 'multipart/form-data' } }) }}

            {# --- Set gegevens (Titel / Published · Grid / BPM) --- #}
            <div class="section">
                <div class="grid grid-2">
                    <div class="grid">
                        {{ form_row(form.title) }}
                        {{ form_row(form.published) }}
                    </div>
                    <div class="grid">
                        {{ form_row(form.gridSize) }}
                        {{ form_row(form.setBPM) }}
                    </div>
                </div>
            </div>

            {# --- Upload + Assets naast elkaar --- #}
            <div class="section">
                <h2 class="section-title">Assets</h2>
                <div class="grid grid-2">
                    <div>
                        <h3 class="label" style="margin:0 0 6px">Upload MIDI-bestanden</h3>
                        {{ form_row(form.midiFiles) }}
                    </div>

                    <div>
                        <h3 class="label" style="margin:0 0 6px">Bestaande assets</h3>
                        {% if assets is defined and assets|length %}
                            <div class="chips" style="margin-top:8px">
                                {% for a in assets %}
                                    <div class="chip">
                                        <span>{{ a.originalName }}</span>
                                        <span class="subtle">
                                          ({% if a.size is not null %}{{ (a.size / 1024)|number_format(1, '.', ' ') }} KB{% else %}–{% endif %})
                                        </span>
                                        <div class="chip-actions">
                                            <a href="{{ path('doc_asset_download', { id: document.id, assetId: a.id }) }}" class="btn-mini">Download</a>
                                            <button
                                                    type="button"
                                                    class="btn-mini danger"
                                                    onclick="deleteAsset('{{ path('doc_asset_delete', { id: document.id, assetId: a.id }) }}', '{{ csrf_token('delete-asset-' ~ a.id) }}', '{{ a.originalName }}')"
                                            >
                                                Verwijder
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="subtle" style="margin-top:6px">Nog geen assets. Upload één of meer .mid-bestanden.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# --- LevelDurations custom UI (vierkante knoppen 0/1) --- #}
            <div class="section">
                <h2 class="section-title">LevelDurations</h2>

                {# 1) Visuele tegel-UI #}
                <div id="ld-tiles" class="ld-tiles" data-target="#ld-hidden-inputs"></div>

                {# 2) Verborgen inputs die Symfony leest #}
                <div id="ld-hidden-inputs"
                     class="ld-hidden"
                     data-prototype="{{ form_widget(form.levelDurations.vars.prototype)|e('html_attr') }}"
                     data-index="{{ form.levelDurations|length }}">
                    {% for field in form.levelDurations %}
                        <div class="ld-item">
                            {{ form_widget(field) }}
                        </div>
                    {% endfor %}
                </div>

                <div class="actions" style="margin-top:10px">
                    <button type="button" class="btn btn-sm" id="ld-add">+ Voeg toe</button>
                    <button type="button" class="btn btn-sm secondary" id="ld-remove">Verwijder laatste</button>
                </div>

                {# We doen custom rendering, dus markeer als rendered #}
                {% do form.levelDurations.setRendered %}
            </div>

            {# --- Tracks (DocumentTrack) --- #}
            <div class="section">
                <div class="form-actions" style="margin-top:10px">
                    <button type="button" class="btn" id="add-track">+ Track toevoegen</button>
                </div>

                {# 1) Bouw volledig prototype van track-kaart #}
                {% set track_proto %}
                    <div class='track-card'>
                        <div class='track-head'>
                            <div class='track-title'>Track __num__</div>
                            <div class='track-actions'>
                                <button type='button' class='btn-ghost' onclick='duplicateTrack(this)'>Dupliceren</button>
                                <button type='button' class='btn-ghost danger' onclick='removeTrack(this)'>Verwijderen</button>
                            </div>
                        </div>

                        {{ form_widget(form.tracks.vars.prototype.trackId) }}

                        <div class='grid'>
                            <div class='subsection'>
                                <label class='label'>Levels</label>

                                <div id='trk-tiles-__num__' class='ld-tiles' data-target='#trk-hidden-__num__'></div>

                                <div id='trk-hidden-__num__'
                                     class='ld-hidden'
                                     data-prototype='{{ form_widget(form.tracks.vars.prototype.levels.vars.prototype)|e('html_attr') }}'
                                     data-index='0'>
                                    {# wordt geseed in JS #}
                                </div>

                                <div class='actions' style='margin-top:8px'>
                                    <button type='button' class='btn-mini' onclick="LD.add('#trk-hidden-__num__','#trk-tiles-__num__')">+ Level</button>
                                    <button type='button' class='btn-mini secondary' onclick="LD.removeLast('#trk-hidden-__num__','#trk-tiles-__num__')">Verwijder laatste</button>
                                </div>
                            </div>

                            <div class='subsection'>
                                <label class='label'>MIDI bestand</label>
                                {{ form_widget(form.tracks.vars.prototype.midiAsset) }}
                            </div>
                        </div>
                    </div>
                {% endset %}

                {# 2) Container met volledige kaart als data-prototype #}
                <div id="tracks"
                     class="tracks"
                     data-index="{{ form.tracks|length }}"
                     data-prototype="{{ track_proto|e('html_attr') }}">

                    {# Bestaande tracks #}
                    {% for trackForm in form.tracks %}
                        <div class="track-card">
                            <div class="track-head">
                                <div class="track-title">Track {{ loop.index }}</div>
                                <div class="track-actions">
                                    <button type="button" class="btn-ghost" onclick="duplicateTrack(this)">Dupliceren</button>
                                    <button type="button" class="btn-ghost danger" onclick="removeTrack(this)">Verwijderen</button>
                                </div>
                            </div>

                            {{ form_widget(trackForm.trackId) }}

                            <div class="grid">
                                <div class="subsection">
                                    <label class="label">Levels</label>

                                    {# A) Tegelcontainer (visueel) #}
                                    <div id="trk-tiles-{{ loop.index0 }}" class="ld-tiles" data-target="#trk-hidden-{{ loop.index0 }}"></div>

                                    {# B) Verborgen inputs die Symfony leest #}
                                    <div id="trk-hidden-{{ loop.index0 }}"
                                         class="ld-hidden"
                                         data-prototype="{{ form_widget(trackForm.levels.vars.prototype)|e('html_attr') }}"
                                         data-index="{{ trackForm.levels|length }}">
                                        {% for levelField in trackForm.levels %}
                                            <div class="ld-item">{{ form_widget(levelField) }}</div>
                                        {% endfor %}
                                    </div>

                                    <div class="actions" style="margin-top:8px">
                                        <button type="button" class="btn-mini" onclick="LD.add('#trk-hidden-{{ loop.index0 }}','#trk-tiles-{{ loop.index0 }}')">+ Level</button>
                                        <button type="button" class="btn-mini secondary" onclick="LD.removeLast('#trk-hidden-{{ loop.index0 }}','#trk-tiles-{{ loop.index0 }}')">Verwijder laatste</button>
                                    </div>
                                </div>

                                <div class="subsection">
                                    <label class="label">MIDI bestand</label>
                                    {{ form_widget(trackForm.midiAsset) }}
                                    {% if trackForm.midiAsset.vars.choices is defined and trackForm.midiAsset.vars.choices|length == 0 %}
                                        <p class="subtle" style="margin-top:6px">Nog geen MIDI-assets. Upload ze bovenaan.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <p class="subtle">Nog geen tracks. Voeg er één toe.</p>
                    {% endfor %}
                </div>
            </div>

            {# --- Acties onderaan --- #}
            <div class="form-actions">
                <button class="btn" type="submit">Opslaan</button>
                <a class="btn secondary" href="{{ path('app_dashboard') }}">Terug</a>
            </div>

            {# Markeer custom gerenderde velden #}
            {% do form.tracks.setRendered %}

            {{ form_end(form) }}
        </div>
    </div>

    <script>
        /* ==========================================================================
           0) BOOTSTRAP IIFE
           ========================================================================== */
        (function() {

            /* ==========================================================================
               1) GENERIC COLLECTION HELPERS  (BEWAREN)
               ========================================================================== */
            window.addCollectionItem = function(containerId) {
                const container = document.getElementById(containerId);
                if (!container) return;
                const index = parseInt(container.dataset.index || '0', 10);
                const proto = container.dataset.prototype?.replace(/__name__/g, index);
                if (!proto) return;

                const wrapper = document.createElement('div');
                wrapper.className = 'collection-item';
                wrapper.innerHTML = proto + '<button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>';
                container.appendChild(wrapper);
                container.dataset.index = String(index + 1);
            };

            window.removeCollectionItem = function(btn) {
                const item = btn.closest('.collection-item');
                if (item) item.remove();
            };


            /* ==========================================================================
               2) ASSET DELETE HELPER  (BEWAREN)
               ========================================================================== */
            window.deleteAsset = function (url, token, filename) {
                if (!confirm(`Weet je zeker dat je ${filename} wilt verwijderen?`)) return;

                /** @type {HTMLFormElement} */
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = url;

                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '_token';
                tokenInput.value = token;

                form.appendChild(tokenInput);
                document.body.appendChild(form);
                form.submit();
            };


            /* ==========================================================================
               3) LD TEGEL-UI MODULE  (HERGEBRUIK + UITGEBREID MET RESIZE)
               ========================================================================== */
            window.LD = {
                _stripRequired(hidden) {
                    hidden.querySelectorAll('input').forEach(inp => {
                        inp.removeAttribute('required');
                        inp.setAttribute('novalidate', 'novalidate');
                    });
                },

                _rebuild(hiddenSel, tilesSel) {
                    const hidden = document.querySelector(hiddenSel);
                    const tiles  = document.querySelector(tilesSel);
                    if (!hidden || !tiles) return;

                    tiles.innerHTML = '';
                    this._stripRequired(hidden);

                    const inputs = hidden.querySelectorAll('.ld-item input');
                    inputs.forEach((input, idx) => {
                        // forceer 0/1
                        const v = String(input.value || '0') === '1' ? 1 : 0;
                        if (String(input.value) !== String(v)) input.value = String(v);

                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'ld-square' + (v ? ' on' : '');
                        btn.dataset.index = String(idx);
                        btn.setAttribute('aria-pressed', v ? 'true' : 'false');
                        btn.textContent = v ? '1' : '0';
                        btn.addEventListener('click', () => {
                            const now = btn.classList.contains('on') ? 0 : 1;
                            btn.classList.toggle('on', !!now);
                            btn.setAttribute('aria-pressed', now ? 'true' : 'false');
                            btn.textContent = String(now);
                            input.value = String(now);
                        });
                        tiles.appendChild(btn);
                    });
                },

                add(hiddenSel, tilesSel) {
                    const hidden = document.querySelector(hiddenSel);
                    if (!hidden) return;

                    const idx = parseInt(hidden.dataset.index || '0', 10);
                    const proto = hidden.dataset.prototype?.replace(/__name__/g, idx);
                    if (!proto) return;

                    const wrap = document.createElement('div');
                    wrap.className = 'ld-item';
                    wrap.innerHTML = proto;

                    const inp = wrap.querySelector('input');
                    if (inp) {
                        inp.value = '0';
                        inp.removeAttribute('required');
                        inp.setAttribute('novalidate', 'novalidate');
                    }

                    hidden.appendChild(wrap);
                    hidden.dataset.index = String(idx + 1);
                    this._rebuild(hiddenSel, tilesSel);
                },

                removeLast(hiddenSel, tilesSel) {
                    const hidden = document.querySelector(hiddenSel);
                    if (!hidden) return;
                    const items = hidden.querySelectorAll('.ld-item');
                    if (!items.length) return;

                    items[items.length - 1].remove();
                    hidden.dataset.index = String(items.length - 1);
                    this._rebuild(hiddenSel, tilesSel);
                },

                seedIfEmpty(hiddenSel, tilesSel) {
                    const hidden = document.querySelector(hiddenSel);
                    if (!hidden) return;
                    const items = hidden.querySelectorAll('.ld-item');
                    if (!items.length) this.add(hiddenSel, tilesSel);
                    else this._rebuild(hiddenSel, tilesSel);
                },

                /** Nieuw: resize hidden+tiles naar exact targetLen (pad met 0 of truncate) */
                resizeTo(hiddenSel, tilesSel, targetLen) {
                    const hidden = document.querySelector(hiddenSel);
                    if (!hidden) return;

                    let idx = parseInt(hidden.dataset.index || '0', 10);
                    const items = hidden.querySelectorAll('.ld-item');

                    // Truncate
                    if (items.length > targetLen) {
                        for (let i = items.length - 1; i >= targetLen; i--) {
                            items[i].remove();
                        }
                        idx = Math.min(idx, targetLen);
                    }

                    // Pad met 0
                    while (hidden.querySelectorAll('.ld-item').length < targetLen) {
                        const i = parseInt(hidden.dataset.index || '0', 10);
                        const proto = hidden.dataset.prototype?.replace(/__name__/g, i);
                        if (!proto) break;
                        const wrap = document.createElement('div');
                        wrap.className = 'ld-item';
                        wrap.innerHTML = proto;

                        const inp = wrap.querySelector('input');
                        if (inp) {
                            inp.value = '0';
                            inp.removeAttribute('required');
                            inp.setAttribute('novalidate', 'novalidate');
                        }

                        hidden.appendChild(wrap);
                        hidden.dataset.index = String(i + 1);
                    }

                    // Zet index op huidig aantal (veilig)
                    const finalCount = hidden.querySelectorAll('.ld-item').length;
                    hidden.dataset.index = String(finalCount);

                    // Tegels updaten
                    if (tilesSel) this._rebuild(hiddenSel, tilesSel);
                }
            };


            /* ==========================================================================
               4) SYNC-MECHANISME: Track-levels koppelen aan set-levels
               ========================================================================== */
            const SET_HIDDEN = '#ld-hidden-inputs';
            const SET_TILES  = '#ld-tiles';

            function getSetLevelCount() {
                const hidden = document.querySelector(SET_HIDDEN);
                return hidden ? hidden.querySelectorAll('.ld-item').length : 0;
            }

            function syncAllTracksToSetCount() {
                const targetLen = getSetLevelCount();
                // elke track-kaart: zoek LD hidden/tiles of fallback
                document.querySelectorAll('#tracks .track-card').forEach((card, i) => {
                    const hidden = card.querySelector(`#trk-hidden-${i}`);
                    const tiles  = card.querySelector(`#trk-tiles-${i}`);
                    if (hidden && tiles) {
                        LD.resizeTo(`#${hidden.id}`, `#${tiles.id}`, targetLen);
                    } else {
                        // Fallback: oude collection zonder tegels
                        const coll = card.querySelector('.collection[data-prototype]');
                        if (coll) {
                            // Resize door add/removeCollectionItem te simuleren
                            const count = coll.querySelectorAll('.collection-item').length;
                            if (count > targetLen) {
                                for (let k = count - 1; k >= targetLen; k--) {
                                    const it = coll.querySelectorAll('.collection-item')[k];
                                    it?.remove();
                                }
                                coll.dataset.index = String(Math.min(parseInt(coll.dataset.index||'0',10), targetLen));
                            } else if (count < targetLen) {
                                // id nodig om addCollectionItem te kunnen gebruiken
                                if (!coll.id) {
                                    coll.id = `levels-fallback-${i}`;
                                }
                                while (coll.querySelectorAll('.collection-item').length < targetLen) {
                                    window.addCollectionItem(coll.id);
                                    // de nieuwe input staat default op '0' via prototype-attr? anders forceren:
                                    const lastInput = coll.querySelector('.collection-item:last-child input');
                                    if (lastInput) lastInput.value = '0';
                                }
                            }
                        }
                    }
                });
            }


            /* ==========================================================================
               5) TRACKS: toevoegen/dupliceren/verwijderen + initialisatie
               ========================================================================== */
            const tracks = document.getElementById('tracks');

            function wireNewTrackCard(card, idx) {
                // A) LD-structuur
                const hidden = card.querySelector(`#trk-hidden-${idx}`);
                const tiles  = card.querySelector(`#trk-tiles-${idx}`);
                if (hidden && tiles) {
                    // seed (minstens 1), daarna syncen naar set-lengte
                    LD.seedIfEmpty(`#${hidden.id}`, `#${tiles.id}`);
                    LD.resizeTo(`#${hidden.id}`, `#${tiles.id}`, getSetLevelCount());
                    return;
                }

                // B) Fallback-collection
                const coll = card.querySelector('.collection[data-prototype]');
                if (coll) {
                    // Seed 1 item indien leeg
                    if (parseInt(coll.dataset.index || '0', 10) === 0) {
                        const seedProto = coll.dataset.prototype?.replace(/__name__/g, 0);
                        if (seedProto) {
                            const item = document.createElement('div');
                            item.className = 'collection-item';
                            item.innerHTML = seedProto + '<button type="button" class="btn-mini danger" onclick="removeCollectionItem(this)">×</button>';
                            coll.appendChild(item);
                            coll.dataset.index = '1';
                        }
                    }
                    // Daarna sync naar set-lengte
                    // id nodig voor addCollectionItem
                    if (!coll.id) coll.id = `levels-fallback-${idx}`;
                    const targetLen = getSetLevelCount();
                    let count = coll.querySelectorAll('.collection-item').length;
                    while (count < targetLen) {
                        window.addCollectionItem(coll.id);
                        const lastInput = coll.querySelector('.collection-item:last-child input');
                        if (lastInput) lastInput.value = '0';
                        count++;
                    }
                    if (count > targetLen) {
                        for (let k = count - 1; k >= targetLen; k--) {
                            const it = coll.querySelectorAll('.collection-item')[k];
                            it?.remove();
                        }
                        coll.dataset.index = String(Math.min(parseInt(coll.dataset.index||'0',10), targetLen));
                    }
                }
            }

            function addTrackFromPrototype() {
                if (!tracks) return;

                const index = parseInt(tracks.dataset.index || '0', 10);
                let html = String(tracks.dataset.prototype || '')
                    .replace(/__name__/g, index)
                    .replace(/__num__/g, index + 1);

                if (!html) return;

                const wrapper = document.createElement('div');
                wrapper.innerHTML = html;
                const card = wrapper.firstElementChild;

                tracks.appendChild(card);
                tracks.dataset.index = String(index + 1);

                // initialiseer + sync nieuwe kaart
                wireNewTrackCard(card, index);
            }

            document.getElementById('add-track')?.addEventListener('click', addTrackFromPrototype);

            window.removeTrack = function(btn) { btn.closest('.track-card')?.remove(); };
            window.duplicateTrack = function(btn) {
                addTrackFromPrototype();
                // (optioneel) kopieer waarden hier
            };

            // Init voor bestaande kaarten bij pageload
            document.querySelectorAll('#tracks .track-card').forEach((card, i) => wireNewTrackCard(card, i));


            /* ==========================================================================
               6) KOPPELING SET-LEVELS → ALLE TRACKS (directe sync bij wijziging)
               ========================================================================== */
            // Init/laden
            LD.seedIfEmpty(SET_HIDDEN, SET_TILES);
            syncAllTracksToSetCount();

            // Knoppen op set-niveau: overschrijf/voeg handlers toe zodat sync volgt
            const ldAddBtn    = document.getElementById('ld-add');
            const ldRemoveBtn = document.getElementById('ld-remove');

            if (ldAddBtn) {
                ldAddBtn.addEventListener('click', () => {
                    LD.add(SET_HIDDEN, SET_TILES);
                    syncAllTracksToSetCount();
                });
            }
            if (ldRemoveBtn) {
                ldRemoveBtn.addEventListener('click', () => {
                    LD.removeLast(SET_HIDDEN, SET_TILES);
                    syncAllTracksToSetCount();
                });
            }


            /* ==========================================================================
               7) SUBMIT-VANGNET: required strippen
               ========================================================================== */
            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', () => {
                    document.querySelectorAll('.ld-hidden').forEach(h => LD._stripRequired(h));
                });
            }

        })(); // einde IIFE
    </script>

    {# ===== Styles specifiek voor LevelDurations (vult jouw bestaande styles aan) ===== #}
    <style>
        /* LevelDurations tegel-UI */
        .ld-tiles { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 6px }
        .ld-square{
            width:36px; height:36px; border-radius:8px;
            border:1px solid #243148; background:#0b1224; color:var(--text);
            font-weight:600; display:inline-flex; align-items:center; justify-content:center;
            cursor:pointer; user-select:none;
        }
        .ld-square.on{
            border-color: var(--accent);
            box-shadow: 0 0 0 4px var(--ring);
            background: linear-gradient(180deg,var(--accent),var(--accent-600));
            color:#fff;
        }
        .ld-hidden{ display:none }
    </style>
{% endblock %}
